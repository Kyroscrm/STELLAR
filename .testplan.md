## üß™ Required Tests (Minimum 3 per API or CRUD Path)

### Lead Module
- [ ] ‚úÖ Can create new lead (happy path)
- [ ] ‚ö†Ô∏è Missing field throws validation error
- [ ] üîê Unauthorized user cannot access another user's leads (RLS test)

### Estimate Module
- [ ] ‚úÖ Can submit estimate form with line items
- [ ] üí• Estimate modal handles failed Supabase mutation gracefully
- [ ] üîÅ Optimistic update reverts on server error

### Invoice Module
- [ ] ‚úÖ Admin can create invoice and auto-link to customer/job
- [ ] ‚ùå Regular user cannot modify other's invoice (RLS test)
- [ ] üîÅ Invoice edit form shows toast and persists data on reload

### General
- [ ] Global error boundary catches failed async operations
- [ ] Skeletons show during data loading
- [ ] Dark mode and mobile view fully functional
"""
.testplan.md: Unit & Integration Tests for Each Module

1. Common Utilities & Hooks

Unit: Test date and formatting helpers; error handler logic.

Integration: Mock Supabase client with MSW; verify hooks (useLeads, useCustomers, etc.) handle loading, success, and error states.

2. Authentication & Authorization

Unit:

has_permission Edge Function: valid/invalid user and permission.

Supabase Auth wrapper: login, logout, session refresh.

Integration:

RLS policy enforcement: user with/without permission can/cannot query protected tables.

3. Leads Module

Unit:

calculateLeadScore function for various input scenarios.

assignLead logic (round-robin, territory rules).

Integration:

Creating a lead triggers Edge Functions (calculate-lead-score, assign-lead).

API returns lead with populated score and assigned_user_id.

4. Customers Module

Unit: Validation functions (email, phone formats).

Integration:

CRUD operations via useCustomers hook respect RLS.

Activity log trigger on create/update/delete captures correct diff.

5. Jobs & Tasks Module

Unit:

calculateJobProgress and calculateJobCost functions.

Task dependency resolution logic.

Integration:

Creating/updating tasks updates job progress.

Logging time entries updates job cost.

6. Estimates & Invoices Module

Unit:

Total calculation for line items and taxes.

Partial payment balance computation.

Integration:

Creating an estimate logs activity and notifies client portal token.

Approving an estimate transitions to invoice creation via workflow.

Payment webhook updates invoice amount_paid and balance_due.

7. Workflow Automation Engine

Unit:

Trigger-condition evaluator for basic JSONB conditions.

Action executor: email, create task, update record mocks.

Integration:

Defining a workflow in DB fires correct sequence in workflow_logs.

Failure scenarios log errors correctly.

8. Dashboard & Analytics

Unit:

KPI calculation functions for sample datasets.

Integration:

Scheduled calculate-kpis Edge Function populates dashboard_metrics_cache.

useDashboardPreferences persists and retrieves layout.

9. Reporting Module

Unit:

Query builder logic: filter, sort combinations.

Integration:

Generating a report writes expected CSV/PDF to storage.

Scheduling report delivery triggers email send mock.

10. Integrations (Email/SMS/Accounting)

Unit:

Email template rendering and validation.

SMS payload formatting.

Integration:

send-email Edge Function calls provider API mock.

Accounting sync functions push/pull correct data.

11. Security & Health

Unit:

Health-check endpoint returns 200 and version info.

Rate limiter logic blocks after threshold.

Integration:

Penetration tests: no CORS/SOP breaches.

MFA flow E2E: enable, verify code, login.

Test Data Requirements:

Seed DB with realistic volumes (1k+ leads, 500+ customers, 200+ jobs).

Include edge cases: missing optional fields, boundary dates, special characters.

Roles: Admin, Sales, PM, Accountant, Client tokens.

Coverage Targets:

Unit: ‚â•80%

Integration: cover all critical flows

E2E: smoke tests for each user journey

# üß™ .testplan.md ‚Äî Stellar CRM Test Coverage Contract

## Requirements Per Component
Each `.tsx` or `.ts` file must have:
- ‚úÖ Happy path test
- ‚úÖ Edge case test
- ‚úÖ Failure scenario test
- ‚úÖ RLS coverage (where applicable)
- ‚úÖ Schema validation (Zod/Pydantic)
- ‚úÖ Logging test (if mutation logs to activity_logs)

## Modules to Cover
- Leads: creation, conversion, merge, scoring
- Customers: segmentation, status updates
- Jobs: lifecycle, assignments, dependencies
- Estimates: templates, markup, approval flow
- Invoices: partials, refunds, Stripe hooks
- Tasks: Gantt, assignments, comments
- Auth: MFA, sessions, password reset
- Portal: role-specific view assertions
- Settings: company, users, permissions

## Output Folder
Cursor should place all test files inside `/tests/` and mirror the component structure.

## Integration Scenarios
- Estimate ‚Üí Job ‚Üí Invoice flow
- Invoice payment triggers status + logs
- Task completion triggers job progress
- Role change invalidates access
- Stripe/QuickBooks/Email integration mocks
"""
